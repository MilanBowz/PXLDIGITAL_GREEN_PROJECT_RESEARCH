<template>
  <div class="dashboard-shell">
    <header class="shell-header">
      <div>
        <h2>LoRa Fleet Overview</h2>
        <p>Live health metrics from your remote devices.</p>
      </div>
      <div
        class="device-count"
        v-if="Array.isArray(msg?.payload)"
      >
        {{ msg.payload.length }} device{{ msg.payload.length === 1 ? "" : "s" }}
      </div>
    </header>

    <section
      v-if="Array.isArray(msg?.payload) && msg.payload.length"
      class="summary-grid"
    >
      <article
        class="summary-card"
        v-for="item in summaryCards(msg.payload)"
        :key="item.label"
      >
        <div class="summary-icon">{{ item.icon }}</div>
        <div class="summary-meta">
          <div class="summary-label">{{ item.label }}</div>
          <div class="summary-value">{{ item.value }}</div>
          <div class="summary-caption">{{ item.caption }}</div>
        </div>
      </article>
    </section>

    <div
      v-if="Array.isArray(msg?.payload) && msg.payload.length"
      class="device-grid"
    >
      <article
        class="device-card device-card--neo"
        v-for="d in msg.payload"
        :key="d.deviceId || d.device || d.id"
        :class="{
          'is-offline': freshnessClass(d.lastSeen) === 'offline',
          'is-stale': freshnessClass(d.lastSeen) === 'idle'
        }"
      >
        <header class="card-header card-header--neo">
          <div class="identity">
            <span
              class="status-dot"
              :class="freshnessClass(d.lastSeen)"
            ></span>
            <div class="identity-text">
              <span class="device-name">
                {{ d.deviceId || d.device || "Unnamed device" }}
              </span>
              <span
                class="identity-sub"
                v-if="d.statusText"
              >
                {{ d.statusText }}
              </span>
            </div>
          </div>
          <div class="card-header-right">
            <span
              class="status-pill"
              :class="freshnessClass(d.lastSeen)"
            >
              {{ statusLabel(d.lastSeen) }}
            </span>
            <span class="last-seen">
              <strong>Last:</strong>
              {{ formatLastSeen(d.lastSeen) }}
            </span>
          </div>
        </header>

        <section
          class="card-hero card-hero--neo"
          :class="temperatureBand(d.tempC)"
        >
          <div class="hero-temp hero-temp--badge">
            <div class="hero-temp-circle">
              <span class="hero-value">
                {{
                  d.tempC_str
                    ? d.tempC_str
                    : Number.isFinite(d.tempC)
                    ? d.tempC.toFixed(1)
                    : "‚Äî"
                }}
              </span>
              <span class="hero-unit">¬∞C</span>
            </div>
          </div>

          <div class="hero-meta hero-meta--grid">
            <div
              class="hero-stat"
              v-if="Number.isFinite(d.lat) && Number.isFinite(d.lon)"
            >
              <span class="hero-label">GPS lock</span>
              <a
                class="hero-data link"
                :href="`https://www.google.com/maps?q=${d.lat},${d.lon}`"
                target="_blank"
                rel="noopener noreferrer"
              >
                {{ d.lat.toFixed(5) }}, {{ d.lon.toFixed(5) }}
              </a>
            </div>
            <div class="hero-stat" v-if="Number.isFinite(d.alt)">
              <span class="hero-label">Altitude</span>
              <span class="hero-data">{{ Math.round(d.alt) }} m</span>
            </div>
            <div class="hero-stat" v-if="Number.isFinite(d.sats)">
              <span class="hero-label">Satellites</span>
              <span class="hero-data">{{ d.sats }}</span>
            </div>
            <div class="hero-stat" v-if="d.ts">
              <span class="hero-label">Packet age</span>
              <span class="hero-data">{{ d.ts }}</span>
            </div>
          </div>
        </section>

        <section class="metric-row metric-row--chips">
          <div class="metric-chip" v-if="Number.isFinite(d.rssi)">
            <span class="metric-chip-icon">üì∂</span>
            <div class="metric-chip-text">
              <span class="metric-chip-label">Signal</span>
              <span class="metric-chip-value">{{ d.rssi.toFixed(0) }} dBm</span>
            </div>
          </div>
          <div class="metric-chip" v-if="Number.isFinite(d.battery)">
            <span class="metric-chip-icon">üîã</span>
            <div class="metric-chip-text">
              <span class="metric-chip-label">Battery</span>
              <span class="metric-chip-value">{{ Math.round(d.battery) }}%</span>
            </div>
          </div>
          <div class="metric-chip" v-if="Number.isFinite(d.alt)">
            <span class="metric-chip-icon">ÔøΩ</span>
            <div class="metric-chip-text">
              <span class="metric-chip-label">Altitude</span>
              <span class="metric-chip-value">{{ Math.round(d.alt) }} m</span>
            </div>
          </div>
          <div class="metric-chip" v-if="d.ts">
            <span class="metric-chip-icon">‚è±Ô∏è</span>
            <div class="metric-chip-text">
              <span class="metric-chip-label">Packet age</span>
              <span class="metric-chip-value">{{ d.ts }}</span>
            </div>
          </div>
        </section>

        <div class="card-actions card-actions--neo">
          <div class="card-actions-left" v-if="Number.isFinite(d.lat) && Number.isFinite(d.lon)">
            <a
              class="ghost-button primary"
              :href="`https://www.google.com/maps?q=${d.lat},${d.lon}`"
              target="_blank"
              rel="noopener noreferrer"
            >
              <span class="button-icon">üó∫Ô∏è</span>
              View on map
            </a>
            <button
              type="button"
              class="ghost-button"
              @click="copyCoordinates(d)"
            >
              <span class="button-icon">üìã</span>
              Copy coords
            </button>
          </div>
          <div
            class="card-actions-left card-actions-left--disabled"
            v-else
          >
            <span class="no-fix">No GPS fix yet</span>
          </div>
          <div class="card-actions-right">
            <button
              type="button"
              class="ghost-button danger"
              @click="removeDevice(d)"
            >
              <span class="button-icon">üóëÔ∏è</span>
              Remove
            </button>
          </div>
        </div>

        <footer class="card-footer card-footer--neo">
          <span class="tag" v-if="Number.isFinite(d.tempC) && d.tempC > 28">High temp</span>
          <span class="tag" v-if="Number.isFinite(d.tempC) && d.tempC < 5">Cold alert</span>
          <span class="tag" v-if="Number.isFinite(d.sats) && d.sats < 4">Weak GPS</span>
          <span class="tag" v-if="Number.isFinite(d.battery) && d.battery < 20">Low battery</span>
          <span class="tag muted" v-if="d.fwVersion">FW {{ d.fwVersion }}</span>
        </footer>
      </article>
    </div>

    <div v-else class="empty-state">
      <div class="empty-icon">üì°</div>
      <h3>No LoRa devices yet‚Ä¶</h3>
      <p>Waiting for data from your device. They will appear here as soon as a payload arrives.</p>
    </div>
  </div>
</template>

<style scoped>
  :root {
    color-scheme: dark;
  }

  .dashboard-shell {
    display: flex;
    flex-direction: column;
    gap: 22px;
    padding: 14px;
    color: #e8edf5;
    font-family: "Inter", "Segoe UI", sans-serif;
  }

  .shell-header {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
    background: linear-gradient(135deg, rgba(30, 64, 175, 0.45), rgba(15, 23, 42, 0.7));
    padding: 16px 20px;
    border-radius: 16px;
    border: 1px solid rgba(59, 130, 246, 0.25);
    box-shadow: 0 18px 32px rgba(15, 23, 42, 0.35);
  }

  .shell-header h2 {
    margin: 0;
    font-size: 26px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .shell-header p {
    margin: 4px 0 0;
    font-size: 14px;
    color: #94a3b8;
  }

  .device-count {
    align-self: flex-start;
    padding: 6px 14px;
    border-radius: 999px;
    background: rgba(59, 130, 246, 0.16);
    border: 1px solid rgba(59, 130, 246, 0.35);
    font-size: 13px;
    font-weight: 600;
    color: #60a5fa;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    gap: 16px;
  }

  .summary-card {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 16px 18px;
    border-radius: 16px;
    background: linear-gradient(120deg, rgba(59, 130, 246, 0.14), rgba(15, 23, 42, 0.86));
    border: 1px solid rgba(148, 163, 184, 0.22);
    box-shadow: 0 14px 28px rgba(15, 23, 42, 0.28);
    backdrop-filter: blur(4px);
  }

  .summary-icon {
    font-size: 24px;
  }

  .summary-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #94a3b8;
  }

  .summary-value {
    font-size: 22px;
    font-weight: 700;
    color: #f8fafc;
  }

  .summary-caption {
    font-size: 12px;
    color: #a3b4ce;
  }

  .device-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
    gap: 20px;
  }

  .device-card {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 18px;
    padding: 22px;
    border-radius: 20px;
    background: radial-gradient(140% 140% at 0% 0%, rgba(96, 165, 250, 0.28), rgba(15, 23, 42, 0.94));
    border: 1px solid rgba(148, 163, 184, 0.18);
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    backdrop-filter: blur(7px);
  }

  .device-card:hover {
    transform: translateY(-5px);
    border-color: rgba(96, 165, 250, 0.45);
    box-shadow: 0 24px 48px rgba(37, 99, 235, 0.27);
  }

  .device-card.is-offline {
    background: radial-gradient(140% 140% at 0% 0%, rgba(248, 113, 113, 0.32), rgba(15, 23, 42, 0.95));
    border-color: rgba(248, 113, 113, 0.32);
  }

  .device-card.is-stale:not(.is-offline) {
    background: radial-gradient(140% 140% at 0% 0%, rgba(248, 184, 36, 0.28), rgba(15, 23, 42, 0.95));
    border-color: rgba(248, 184, 36, 0.28);
  }

  .card-header {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .card-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .identity {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .device-name {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 0.2px;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    box-shadow: 0 0 8px currentColor;
  }

  .status-dot.online {
    color: #34d399;
  }

  .status-dot.idle {
    color: #facc15;
  }

  .status-dot.offline {
    color: #f87171;
  }

  .status-pill {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border: 1px solid transparent;
    color: #0f172a;
  }

  .status-pill.online {
    background: rgba(34, 197, 94, 0.22);
    border-color: rgba(34, 197, 94, 0.45);
    color: #bbf7d0;
  }

  .status-pill.idle {
    background: rgba(234, 179, 8, 0.2);
    border-color: rgba(234, 179, 8, 0.4);
    color: #fef3c7;
  }

  .status-pill.offline {
    background: rgba(248, 113, 113, 0.2);
    border-color: rgba(248, 113, 113, 0.4);
    color: #fecaca;
  }

  .last-seen {
    font-size: 13px;
    color: #b0bbcb;
  }

  .last-seen strong {
    color: #94a3b8;
    font-weight: 600;
    margin-right: 4px;
  }

  .card-body {
    display: flex;
    flex-direction: column;
    gap: 18px;
    padding: 20px 22px;
    border-radius: 18px;
    background: rgba(15, 23, 42, 0.78);
    border: 1px solid rgba(148, 163, 184, 0.18);
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.24);
  }

  .card-hero {
    display: flex;
    flex-direction: column;
    gap: 14px;
    padding: 18px 20px;
    border-radius: 16px;
    position: relative;
    overflow: hidden;
    border: 1px solid transparent;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(15, 23, 42, 0.85));
  }

  .card-hero.cool {
    background: linear-gradient(135deg, rgba(96, 165, 250, 0.24), rgba(15, 23, 42, 0.88));
    border-color: rgba(96, 165, 250, 0.38);
  }

  .card-hero.warm {
    background: linear-gradient(135deg, rgba(234, 179, 8, 0.22), rgba(15, 23, 42, 0.88));
    border-color: rgba(234, 179, 8, 0.35);
  }

  .card-hero.hot {
    background: linear-gradient(135deg, rgba(248, 113, 113, 0.24), rgba(15, 23, 42, 0.9));
    border-color: rgba(248, 113, 113, 0.4);
  }

  .hero-temp {
    display: flex;
    align-items: flex-end;
    gap: 6px;
  }

  .hero-value {
    font-size: 44px;
    font-weight: 700;
    line-height: 0.9;
    color: #f8fafc;
  }

  .hero-unit {
    font-size: 18px;
    font-weight: 600;
    color: rgba(226, 232, 240, 0.85);
    margin-bottom: 6px;
  }

  .hero-meta {
    display: grid;
    gap: 8px;
  }

  .hero-line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: #e2e8f0;
  }

  .hero-label {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(148, 163, 184, 0.85);
    font-size: 11px;
  }

  .hero-data {
    font-size: 14px;
    font-weight: 600;
    color: #e2e8f0;
  }

  .hero-data.link {
    color: #93c5fd;
    text-decoration: none;
  }

  .hero-data.link:hover {
    text-decoration: underline;
  }

  .metric-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .metric-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(148, 163, 184, 0.1);
  }

  .metric-item:last-child {
    border-bottom: none;
  }

  .metric-icon {
    font-size: 18px;
    filter: drop-shadow(0 0 6px rgba(96, 165, 250, 0.28));
  }

  .metric-text {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .metric-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(148, 163, 184, 0.85);
  }

  .metric-value {
    font-size: 15px;
    font-weight: 600;
    color: #e2e8f0;
    word-break: break-word;
  }

  .card-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .ghost-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 18px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.32);
    background: rgba(15, 23, 42, 0.6);
    color: #cbd5f5;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
  }

  .ghost-button:hover {
    border-color: rgba(148, 163, 184, 0.55);
    background: rgba(30, 41, 59, 0.75);
  }

  .ghost-button.primary {
    border-color: rgba(59, 130, 246, 0.55);
    color: #bfdbfe;
    background: linear-gradient(120deg, rgba(59, 130, 246, 0.25), rgba(30, 64, 175, 0.35));
  }

  .ghost-button.primary:hover {
    border-color: rgba(59, 130, 246, 0.78);
    background: linear-gradient(120deg, rgba(59, 130, 246, 0.35), rgba(30, 64, 175, 0.45));
  }

  .ghost-button.danger {
    border-color: rgba(248, 113, 113, 0.38);
    color: #fecaca;
    background: linear-gradient(120deg, rgba(248, 113, 113, 0.08), rgba(15, 23, 42, 0.6));
  }

  .ghost-button.danger:hover {
    border-color: rgba(248, 113, 113, 0.65);
    background: linear-gradient(120deg, rgba(248, 113, 113, 0.14), rgba(30, 41, 59, 0.75));
  }

  .button-icon {
    font-size: 16px;
    line-height: 1;
  }

  @media (max-width: 680px) {
    .card-body {
      padding: 18px;
    }

    .card-hero {
      padding: 16px;
    }
  }
</style>

<script>
  export default {
    methods: {
      temperatureBand(temp) {
        if (!Number.isFinite(temp)) return '';
        if (temp <= 10) return 'cool';
        if (temp >= 28 && temp < 34) return 'warm';
        if (temp >= 34) return 'hot';
        return '';
      },
      freshnessClass(lastSeen) {
        const ts = lastSeen ? new Date(lastSeen).getTime() : NaN;
        if (!Number.isFinite(ts)) return 'offline';
        const delta = Date.now() - ts;
        if (delta <= 5 * 60 * 1000) return 'online';
        if (delta <= 15 * 60 * 1000) return 'idle';
        return 'offline';
      },
      statusLabel(lastSeen) {
        const map = {
          online: 'Online',
          idle: 'Idle',
          offline: 'Offline'
        };
        return map[this.freshnessClass(lastSeen)] || 'Unknown';
      },
      formatLastSeen(lastSeen) {
        if (!lastSeen) return 'waiting for first payload';
        const ts = new Date(lastSeen);
        if (!Number.isFinite(ts.getTime())) return 'unknown timestamp';
        return ts.toLocaleString([], {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      },
      summaryCards(payload) {
        if (!Array.isArray(payload) || !payload.length) {
          return [
            {
              label: 'Online devices',
              value: '0',
              caption: 'No devices reporting yet',
              icon: 'üü¢'
            },
            {
              label: 'Average temp',
              value: '‚Äî',
              caption: 'No temperature data',
              icon: 'üå°Ô∏è'
            },
            {
              label: 'Weak GPS',
              value: '0',
              caption: 'Satellites < 4',
              icon: 'üì°'
            },
            {
              label: 'Peak altitude',
              value: '‚Äî',
              caption: 'Awaiting telemetry',
              icon: 'üóª'
            }
          ];
        }

        const now = Date.now();
        let online = 0;
        let idle = 0;
        let maxAlt = null;
        let weakGps = 0;
        const temps = [];

        payload.forEach((device) => {
          const seenTs = device && device.lastSeen ? new Date(device.lastSeen).getTime() : NaN;
          if (Number.isFinite(seenTs)) {
            const delta = now - seenTs;
            if (delta <= 5 * 60 * 1000) {
              online += 1;
            } else if (delta <= 15 * 60 * 1000) {
              idle += 1;
            }
          }

          if (Number.isFinite(device?.tempC)) {
            temps.push(Number(device.tempC));
          }

          if (Number.isFinite(device?.alt)) {
            maxAlt = maxAlt === null ? Number(device.alt) : Math.max(maxAlt, Number(device.alt));
          }

          if (Number.isFinite(device?.sats) && Number(device.sats) < 4) {
            weakGps += 1;
          }
        });

        const avgTemp = temps.length
          ? `${(temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1)} ¬∞C`
          : '‚Äî';
        const offline = payload.length - online - idle;

        return [
          {
            label: 'Online devices',
            value: `${online}/${payload.length}`,
            caption: `Idle ${idle} ‚Ä¢ Offline ${offline < 0 ? 0 : offline}`,
            icon: 'üü¢'
          },
          {
            label: 'Average temp',
            value: avgTemp,
            caption: temps.length ? `From ${temps.length} devices` : 'No temperature data',
            icon: 'üå°Ô∏è'
          },
          {
            label: 'Weak GPS',
            value: weakGps,
            caption: 'Satellites < 4',
            icon: 'üì°'
          },
          {
            label: 'Peak altitude',
            value: maxAlt !== null ? `${Math.round(maxAlt)} m` : '‚Äî',
            caption: maxAlt !== null ? 'Highest reported' : 'Awaiting telemetry',
            icon: 'üóª'
          }
        ];
      },
      copyCoordinates(device) {
        if (!Number.isFinite(device?.lat) || !Number.isFinite(device?.lon)) return;
        const coords = `${device.lat}, ${device.lon}`;
        if (navigator?.clipboard?.writeText) {
          navigator.clipboard.writeText(coords).catch(() => {
            window.prompt('Copy coordinates', coords);
          });
        } else {
          window.prompt('Copy coordinates', coords);
        }
      }
      ,
      removeDevice(device) {
        const id = device?.deviceId || device?.device || device?.id;
        const name = device?.deviceId || device?.device || 'Unnamed device';
        if (!id) return;
        const ok = window.confirm(`Remove device "${name}"? This will delete it from the dashboard.`);
        if (!ok) return;

        const msg = { payload: { action: 'delete', deviceId: id } };

        if (typeof this?.send === 'function') {
          this.send(msg);
          return;
        }

        if (typeof send === 'function') {
          send(msg);
          return;
        }

        if (typeof scope !== 'undefined' && scope && typeof scope.send === 'function') {
          scope.send(msg);
          return;
        }

        if (window?.parent?.postMessage) {
          window.parent.postMessage({ type: 'node-red-ui', msg }, '*');
        }
      }
    }
  };
</script>
