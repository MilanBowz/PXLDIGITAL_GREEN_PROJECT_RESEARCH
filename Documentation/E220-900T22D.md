# E220-900T22D LoRa Module [Maxime]

## Beschrijving:  
De E220-900T22D is een LoRa-transceiver module gebaseerd op de LLCC68-chip, ontworpen voor long-range draadloze communicatie. Deze module wordt in het project gebruikt om GPS-locatie- en temperatuurdata over afstanden tot 1.1 km te verzenden en te ontvangen tussen een ESP32-zender en een Raspberry Pi-ontvanger.

## Properties
- **Communicatieprotocol**: LoRa (Long Range)
- **Interface**: UART (TX/RX)
- **Frequentieband**: 868 MHz (Europa)
- **Voedingsspanning**: 3.3V - 5V
- **Configuratiepinnen**: M0, M1, AUX
- **Baudrate**: 9600 bps (standaard)
- **Getest maximale bereik**:  +-1.1 km  (met 15 cm gluestick antenne)
- **Absolute maximale bereik**: 5 km  (Volgens fabrikant in ideale omstandigheden )

## Methoden
- **Initialisatie**: Serial2.begin() voor UART-communicatie
- **Configuratie**: setConfiguration() voor module-instellingen
- **Verzenden**: sendMessage() voor data-transmissie
- **Ontvangen**: receiveMessage() voor data-ontvangst
- **Status controle**: available() voor beschikbaarheid

## Gebruik

### Hardware Aansluiting
De E220-900T22D module wordt aangesloten op de ESP32 via de volgende GPIO-pinnen:

| LoRa E220 | ESP32 | Wemos D1 Mini Pro | Opmerkingen |
|-----------|-------|-------------------|-------------|
| M0 | 21 / D21 | D7 | Normale modus (GND) / Configuratie modus (+3.3V) |
| M1 | 19 / D19 | D6 | Normale modus (GND) / Configuratie modus (+3.3V) |
| TX | RX2 / D16 | D2 | Communicatie UART |
| RX | TX2 / D17 | D1 | Communicatie UART |
| AUX | AUX: D22/23 | D5 | Busy status E220 |
| VCC | 3.3V - 5V | 5V | Voeding |
| GND | GND | GND | Aarde |

### Software Configuratie
Deze code initialiseert de seriële communicatie met de LoRa-module en opent de configuratie voor aanpassingen.
```c
#include "LoRa_E220.h"  // LoRa library

// Initialize LoRa module: (Serial port, AUX pin, M0 pin, M1 pin)
LoRa_E220 e22ttl(&Serial2, 18, 21, 19);

static const int E220_RX2_PIN = 16; // ESP32 RX2 pin (input from E220 TX)
static const int E220_TX2_PIN = 17; // ESP32 TX2 pin (output to E220 RX)

void setup() {
  Serial.begin(9600);
  
  // Start serial communication for LoRa module
  Serial2.begin(9600, SERIAL_8N1, E220_RX2_PIN, E220_TX2_PIN);
  
  // Start module
  e22ttl.begin();
  
  // Read current configuration
  ResponseStructContainer c = e22ttl.getConfiguration();
  Configuration configuration = *(Configuration*) c.data;
  Serial.println(c.status.getResponseDescription());
  Serial.println(c.status.code);
}
```
**Uitleg**: Deze code importeert de LoRa-bibliotheek, declareert de LoRa-module object met de juiste pinnen, en initialiseert zowel de debug-seriepoort (Serial) als de seriepoort naar de LoRa-module (Serial2). Daarna wordt de huidige configuratie van de module opgevraagd.
### Module Configuratie
Deze code configureert de belangrijkste parameters van de LoRa-module, inclusief adres, kanaal en transmissie-instellingen.
```c
// Configure module settings
configuration.ADDH = 0x00;      // High address byte
configuration.ADDL = 0x01;      // Low address byte (node address)
configuration.CHAN = 0x12;      // Channel for 868 MHz (check datasheet)

// UART and Air settings
configuration.SPED.uartBaudRate = UART_BPS_9600;        // Baudrate voor de UART
configuration.SPED.airDataRate = AIR_DATA_RATE_010_24;  // 2.4 kbps
configuration.SPED.uartParity = MODE_00_8N1;            // 8 databits, 1 stopbit, geen pariteit

// Transmission mode
configuration.TRANSMISSION_MODE.fixedTransmission = FT_TRANSPARENT_TRANSMISSION;
// Transparent transmission zorgt ervoor dat we kunnen versturen en ontvangen
// op alle channels met hetzelfde address

// Save configuration to module
ResponseStatus rs = e22ttl.setConfiguration(configuration, WRITE_CFG_PWR_DWN_SAVE);
Serial.println(rs.getResponseDescription());
Serial.println(rs.code);

// Verify configuration
c = e22ttl.getConfiguration();
configuration = *(Configuration*) c.data;
Serial.println(c.status.getResponseDescription());
Serial.println(c.status.code);
printParameters(configuration);
```
**Uitleg**: Hier worden de specifieke configuratieparameters ingesteld. Het adres (ADDH/ADDL) identificeert de module in het netwerk. Het kanaal (CHAN) wordt ingesteld op 868 MHz voor Europa. De transmissiemodus FT_TRANSPARENT_TRANSMISSION betekent dat de module alle berichten ontvangt, ongeacht het bestemmingsadres. De configuratie wordt naar de module geschreven en daarna opnieuw uitgelezen ter verificatie.
### Data Verzenden
Deze code demonstreert hoe je data via de LoRa-module verzendt, bijvoorbeeld vanuit de seriële monitor of vanuit sensordata.
```c
void loop() {
  // If there's input from serial monitor, send it via LoRa
  if (Serial.available()) {
    String input = Serial.readString();
    e22ttl.sendMessage(input);
    Serial.println("Message sent: " + input);
  }
  
  // Other sensor data sending logic...
  // GPS and temperature data would be formatted and sent here
}
```
**Uitleg**: In de main loop wordt gecontroleerd of er input beschikbaar is vanaf de seriële monitor (debug interface). Als dat zo is, wordt de ingevoerde tekst via de `sendMessage()` functie door de LoRa-module verzonden. Dit is handig voor testdoeleinden. In een echte toepassing zou hier de GPS- en temperatuurdata worden geformatteerd en verzonden.
### Data Ontvangen
Deze code toont hoe je binnenkomende LoRa-berichten ontvangt en verwerkt.
```c
void loop() {
  // Check if data is available from LoRa module
  if (e22ttl.available() > 1) {
    // Read the message
    ResponseContainer rc = e22ttl.receiveMessage();
    
    // Check for errors
    if (rc.status.code != 1) {
      Serial.println("Error: " + rc.status.getResponseDescription());
    } else {
      // Print received data
      Serial.println("Received: " + rc.data);
      
      // Process the data (GPS, temperature, etc.)
      processReceivedData(rc.data);
    }
  }
}
```
**Uitleg**: Deze code controleert continu of er berichten beschikbaar zijn van de LoRa-module. De `available()` functie retourneert het aantal beschikbare bytes; een waarde > 1 geeft aan dat er een compleet bericht is. Bij succesvolle ontvangst wordt het bericht verwerkt. De `processReceivedData()` functie is een placeholder voor jouw eigen logica om de ontvangen sensorwaarden te interpreteren.
### Configuratie Weergeven
Deze functie print alle configuratieparameters van de LoRa-module naar de seriële monitor voor debugging.
```c
void printParameters(struct Configuration configuration) {
  Serial.println("----------------------------------------");
  
  Serial.print(F("HEAD : ")); Serial.print(configuration.COMMAND, HEX);
  Serial.print(" "); Serial.print(configuration.STARTING_ADDRESS, HEX);
  Serial.print(" "); Serial.println(configuration.LENGHT, HEX);
  
  Serial.println(F(" "));
  Serial.print(F("AddH : ")); Serial.println(configuration.ADDH, HEX);
  Serial.print(F("AddL : ")); Serial.println(configuration.ADDL, HEX);
  
  Serial.println(F(" "));
  Serial.print(F("Chan : ")); Serial.print(configuration.CHAN, DEC);
  Serial.print(" -> "); Serial.println(configuration.getChannelDescription());
  
  // ... (volledige print functie zoals in GitHub)
  
  Serial.println("----------------------------------------");
}
```
**Uitleg**: Deze hulpfunctie geeft een overzicht van alle configuratieparameters van de LoRa-module. Het is erg nuttig voor debugging, omdat je zo kunt verifiëren of de module correct is geconfigureerd. De functie gebruikt zowel hexadecimale als binaire weergave, samen met beschrijvende tekst via de `get...Description()` functies.
## Problemen en Oplossingen

### 1. Verkeerde UART Verbinding
**Probleem**: Bij deze error bouwt de code wel maar krijg je een error bij het uploaden van de code.
**Oplossing**:
- Controleer of TX van de module verbonden is met RX van de microcontroller en vice versa
- Verifieer baudrate instellingen (moet 9600 bps zijn)
- Voor stabielere UART verbinding kan je een 4.7KΩ weerstand plaatsen bij de TX en RX verbindingen tussen de ESP32 en de module

### 2. Module Reageert Niet
**Probleem**: Geen respons van de LoRa module na aansluiting.
**Oplossing**:
- Controleer of M0 en M1 pinnen correct zijn aangesloten (beide GND voor normale transmissiemodus)
- Verifieer de AUX pin status (HIGH = beschikbaar, LOW = bezig)
- Controleer voeding (3.3V - 5V)

### 3. Beperkt Bereik
**Probleem**: Signaal bereikt niet de verwachte afstand.
**Oplossing**:
- Gebruik een externe gluestick antenne (15 cm voor 868 MHz)
- Plaats antenne verticaal voor optimale propagatie
- Verhoog transmissievermogen in configuratie (indien mogelijk)
- Zorg voor zichtlijn tussen zender en ontvanger

### 4. Crosstalk Tussen Modules
**Probleem**: Modules ontvangen berichten van andere modules in hetzelfde netwerk.
**Oplossing**:
- Wijzig ADDH en ADDL (adres) voor elke module
- Gebruik verschillende CHAN (kanaal) instellingen
- Overweeg FT_FIXED_TRANSMISSION in plaats van FT_TRANSPARENT_TRANSMISSION voor adresgebaseerde filtering

## Test Procedures

### Bereik Test
```c
void testLoRaRange() {
  Serial.println("=== LoRa Range Test ===");
  Serial.println("Zendt testbericht elke 10 seconden...");
  
  unsigned long lastSendTime = 0;
  int messageCount = 0;
  
  while (true) {
    unsigned long currentTime = millis();
    
    if (currentTime - lastSendTime > 10000) { // Elke 10 seconden
      String testMessage = "Test #" + String(messageCount) + " from " + String(configuration.ADDL, DEC);
      e22ttl.sendMessage(testMessage);
      Serial.println("Sent: " + testMessage);
      
      lastSendTime = currentTime;
      messageCount++;
    }
    
    // Check for incoming messages
    if (e22ttl.available() > 1) {
      ResponseContainer rc = e22ttl.receiveMessage();
      if (rc.status.code == 1) {
        Serial.println("Received: " + rc.data);
      }
    }
    
    delay(100);
  }
}
```
**Uitleg**: Deze testfunctie verzendt elke 10 seconden een testbericht en luistert naar binnenkomende berichten. Het is handig om het bereik en de betrouwbaarheid van de LoRa-verbinding te testen.
### Configuratie Validatie
```c
void validateLoRaConfiguration() {
  Serial.println("=== LoRa Configuration Validation ===");
  
  ResponseStructContainer c = e22ttl.getConfiguration();
  if (c.status.code != 1) {
    Serial.println("Error reading configuration: " + c.status.getResponseDescription());
    return;
  }
  
  Configuration config = *(Configuration*) c.data;
  
  // Check critical parameters
  if (config.ADDH == 0x00 && config.ADDL == 0x01) {
    Serial.println("✓ Address configured correctly");
  } else {
    Serial.println("✗ Address mismatch");
  }
  
  if (config.CHAN == 0x12) {
    Serial.println("✓ Channel set to 868 MHz");
  } else {
    Serial.println("✗ Channel incorrect");
  }
  
  if (config.SPED.uartBaudRate == UART_BPS_9600) {
    Serial.println("✓ Baudrate set to 9600");
  } else {
    Serial.println("✗ Baudrate incorrect");
  }
  
  printParameters(config);
}
```
**Uitleg**: Deze functie controleert of de belangrijkste configuratieparameters correct zijn ingesteld. Het is een snelle manier om te verifiëren of de module goed is geconfigureerd na het opstarten of na configuratiewijzigingen.
## Configuratie Tips

### Voor Optimalisatie
1. **Bereik vs. Stroomverbruik**: Hogere zendvermogen geeft meer bereik maar verbruikt meer stroom.
2. **Data Rate**: Lagere data rates (0.3 kbps) geven langer bereik maar tragere communicatie.
3. **Antenne Selectie**: Gebruik antennes afgestemd op 868 MHz voor beste prestaties in Europa.

### Voor Stabiliteit
1. **Worstcase Scenario's**: Test communicatie bij verschillende weersomstandigheden.
2. **Foutafhandeling**: Implementeer opnieuw verzenden bij mislukte transmissies.
3. **Timeout Management**: Zet timeouts op seriële communicatie om vastlopen te voorkomen.

## Praktijk Bevindingen

### Veldtest Resultaten
- **Maximaal bereik**: 1.1 km met 15 cm gluestick antenne (open veld, zichtlijn)
- **Betrouwbaarheid**: 95%+ pakketbezorging binnen 500 meter
- **Stroomverbruik**: ~120 mA tijdens verzenden, <1 mA in slaapstand

### Aanbevelingen
1. Gebruik de Ebyte Configuration Tool om modules voor te configureren.
2. Implementeer checksums in data pakketten voor integriteitsverificatie.
3. Overweeg meshed network topologie voor grotere dekking.

## Zie ook
- [Ebyte E220-900T22D Manual](https://www.cdebyte.com/products/E220-900T22D/2)
